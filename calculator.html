<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

.line {
  fill: none;
  stroke: rgb(100,100,100);
  stroke-width: 4px;
}

.area {
  stroke: rgb(100,100,100);
  stroke-width: 4px;
  fill: lightsteelblue;
}

.grid line {
  stroke: rgba(150,150,240,0.1);
  stroke-width: 5px;
}

h2 {
  font-weight: lighter;
  color: rgb(100,100,100);
}
select {
  width: 300px;
  font-size: 18px;
}
.label {
  width: 300px;
  display: inline-block;
  font-size: 20px;
  font-weight: strong;
}
</style>
<title>Perception of Probability - Calculator</title>
<body>
<form>
  <span class="label">
  Optimist:
  </span>
  <select id="optimist">
    <option selected="selected">1</option>
    <option>2</option>
    <option>3</option>
    <option>5</option>
    <option>8</option>
    <option>13</option>
    <option>21</option>
    <option>30</option>
    <option>100</option>
  </select>
  <br/>
  <span class="label">
    Pessimist:
  </span>
  <select id="pessimist">
    <option>1</option>
    <option>2</option>
    <option>3</option>
    <option>5</option>
    <option>8</option>
    <option>13</option>
    <option>21</option>
    <option>30</option>
    <option selected="selected">100</option>
  </select>
  <br/>
  <span class="label">
    Probability of the Optimist:
  </span>
  <select id="probability">
  </select>
</form>
<!-- load the d3.js library -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

// set the dimensions and margins of the graph
var margin = {top: 20, right: 20, bottom: 50, left: 70},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// parse the date / time
var parseTime = d3.timeParse("%d-%b-%y");

// set the ranges
var x = d3.scaleLinear().range([0, width]);
var y = d3.scaleLinear().range([height, 0]);

var divCharts = d3.select("body").append("div").attr("class","charts");

// Get the data
d3.csv("https://raw.githubusercontent.com/thiagomata/perceptions-of-probability/master/data/data.csv", function(error, data) {
  if (error) throw error;
  window.data = data;

  var dimensions = data.columns.filter( c => c != "probability");

  d3.select("#probability").selectAll("option").data(dimensions).enter().append("option").text( x => x )

  var dimensionColor =  d3.scaleSequential(d3.interpolateInferno)
      .domain([dimensions.length,0]);

  window.dimensionColor = dimensionColor;

  window.dimensions = dimensions;

  var divChart = divCharts.append("div").attr("class","chart");
  var title = divChart.append("h2");

  function redraw() {

      d3.select("svg").remove();

      var svg = divChart.append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");


      var dimension = d3.select("#probability").node().value;
      var key = dimensions.indexOf(dimension);

      var xMin = 1 * d3.select("#optimist").node().value;
      var xMax = 1 * d3.select("#pessimist").node().value;

      // define the line
      var area = d3.area()
          .curve(d3.curveMonotoneX)
          .x(function(d) {
          console.log(d);
          debugger;
            v = 1 * (d.probability * (xMax - xMin) / 100 + xMin);
            console.log(v);
            return x(v);
          })
          .y1(
            function(d) {
            return y(d[dimension]);
          });

      area.y0(y(0))

      // define the line
      var valueline = d3.line()
          //.curve(d3.curveMonotoneX)
          .x(function(d) { return x(Math.floor(d.probability * (xMax - xMin) / 100 + xMin)); })
          .y(function(d) { return y(d[dimension]); });

      window.valueline = valueline;


      title.text(dimension);


      // Scale the range of the data
      x.domain([xMin, xMax]);
      y.domain([0, 100]);

      // gridlines in x axis function
      function make_x_gridlines() {
          return d3.axisBottom(x)
              .ticks(5)
      }

      // gridlines in y axis function
      function make_y_gridlines() {
          return d3.axisLeft(y)
              .ticks(5)
      }

      // add the X gridlines
      svg.append("g")
        .attr("class", "grid")
        .attr("transform", "translate(0," + height + ")")
        .call(make_x_gridlines()
            .tickSize(-height)
            .tickFormat("")
        )

      // add the Y gridlines
      svg.append("g")
        .attr("class", "grid")
        .call(make_y_gridlines()
            .tickSize(-width)
            .tickFormat("")
        )

      // Add the valueline path.
      // svg.append("path")
      //     .data([data])
      //     .attr("class", "line")
      //     .attr("d", valueline);

      svg.append("path")
          .data([data])
          .attr("class", "area")
          .attr("style", "fill:"+dimensionColor(key))
          .attr("d", area);
      // Add the x Axis
      svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x));

      // text label for the x axis
      svg.append("text")
          .attr("transform",
                "translate(" + (width/2) + " ," +
                               (height + margin.top + 20) + ")")
          .style("text-anchor", "middle")
          .text("Probability");

      // Add the y Axis
      svg.append("g")
          .call(d3.axisLeft(y));

      // text label for the y axis
      svg.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x",0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Perception");
    }

    d3.select("#probability").on("change", redraw );
    d3.select("#optimist").on("change", redraw );
    d3.select("#pessimist").on("change", redraw );
});
</script>
</body>
</html>
